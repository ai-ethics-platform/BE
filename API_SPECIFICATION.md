# AI 윤리 챗봇 API 명세서

## 개요
AI 윤리 토론을 위한 다단계 챗봇 시스템 API입니다. LangChain을 사용하여 구조화된 JSON 응답을 제공합니다.


## 1. 이미지 생성 API

### `POST /chat/image`

이미지 생성을 위한 프롬프트를 LangChain으로 구조화하고, DALL-E로 이미지를 생성합니다.

#### Request Body

```json
{
  "input": "AI 로봇이 사람과 대화하는 장면",
  "step": "image",
  "context": {
    "topic": "AI 윤리",
    "style": "realistic"
  },
  "prompt": {
    "id": "pmpt_xxx",
    "version": "1.0",
    "variables": {
      "style": "fantasy",
      "context": "AI ethics discussion"
    }
  },
  "size": "1024x1024"
}
```

#### Request Schema

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `input` | string | ✅ | 이미지 생성 프롬프트 텍스트 |
| `step` | string | ❌ | 단계 식별자 (기본값: "image") |
| `context` | object | ❌ | 컨텍스트 변수들 (prompt.variables가 없을 때 사용) |
| `prompt` | object | ❌ | 프롬프트 참조 |
| `prompt.id` | string | ❌ | OpenAI Playground Prompt ID |
| `prompt.version` | string | ❌ | 프롬프트 버전 |
| `prompt.variables` | object | ❌ | 프롬프트 변수들 |
| `size` | string | ❌ | 이미지 크기 (기본값: "1024x1024") |

#### Response Schema

```json
{
  "step": "image",
  "image_data_url": "/static/generated_images/dalle_20240101_120000_abc123.png",
  "model": "dall-e-3",
  "size": "1024x1024",
  "parsed_result": {
    "description": "A detailed image description generated by LLM",
    "style": "realistic",
    "size": "1024x1024",
    "reasoning": "This image fits the user's intent because..."
  }
}
```

| 필드 | 타입 | 설명 |
|------|------|------|
| `step` | string | 단계 식별자 |
| `image_data_url` | string | 생성된 이미지 URL (로컬 또는 원격) |
| `model` | string | 사용된 모델 (항상 "dall-e-3") |
| `size` | string | 이미지 크기 |
| `parsed_result` | object | LangChain으로 파싱된 이미지 생성 정보 |
| `parsed_result.description` | string | 상세한 이미지 설명 |
| `parsed_result.style` | string | 예술 스타일이나 톤 |
| `parsed_result.size` | string | 이미지 크기 |
| `parsed_result.reasoning` | string | 이미지가 사용자 의도에 맞는 이유 |

#### 예시 요청 (cURL)

```bash
curl -X POST "http://localhost:8000/api/v1/chat/image" \
  -H "Content-Type: application/json" \
  -d '{
    "input": "AI 로봇이 사람과 대화하는 장면",
    "context": {
      "topic": "AI 윤리"
    },
    "size": "1024x1024"
  }'
```

---

## 2. 다단계 챗봇 API

### `POST /chat/multi-step`

다단계 챗봇 대화를 진행합니다. 각 단계의 응답은 JSON으로 구조화되어 변수를 포함합니다.

#### Request Body

```json
{
  "session_id": "unique-session-id",
  "user_input": "사용자 입력 텍스트",
  "step": "opening"
}
```

#### Request Schema

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `session_id` | string | ✅ | 세션 식별자 |
| `user_input` | string | ✅ | 사용자 입력 텍스트 |
| `step` | string | ❌ | 실행할 단계 (없으면 현재 단계에서 진행) |

#### 단계 순서

1. **opening** - 시작 단계 (변수 불필요)
2. **dilemma** - 딜레마 제시 (다음 단계에 `topic` 변수 전달)
3. **flip** - 선택지 제시 (다음 단계에 `question`, `choice1`, `choice2` 변수 전달)
4. **roles** - 역할 할당 (다음 단계에 `structure` 변수 전달)
5. **ending** - 종료 단계 (`structure`, `role` 변수 필요)

#### Response Schema

```json
{
  "session_id": "unique-session-id",
  "current_step": "opening",
  "response_text": "사용자에게 보여줄 응답 텍스트",
  "parsed_variables": null,
  "context": {
    "opening_result": "이전 단계 결과",
    "opening_user_input": "이전 사용자 입력"
  },
  "next_step": "dilemma",
  "is_complete": false
}
```

| 필드 | 타입 | 설명 |
|------|------|------|
| `session_id` | string | 세션 식별자 |
| `current_step` | string | 현재 실행된 단계 |
| `response_text` | string | 사용자에게 보여줄 응답 텍스트 |
| `parsed_variables` | object \| null | LangChain으로 파싱된 변수들 (단계별로 다름, 파싱 실패 시 null) |
| `context` | object | 전체 컨텍스트 (이전 단계 결과 포함) |
| `next_step` | string | 다음 단계 (없으면 null) |
| `is_complete` | boolean | 마지막 단계 여부 |

#### 단계별 parsed_variables 예시

**opening 단계:**
```json
{}
```
또는
```json
null
```
- 변수 불필요 (다음 단계로 넘어갈 때 변수 전달 안 함)
- LangChain 파싱 실패 시 `null` 반환 가능

**dilemma 단계:**
```json
{
  "topic": "AI 윤리"
}
```
- 다음 단계(flip)에 `topic` 변수 전달
- LangChain 파싱 실패 시 `null` 반환 가능

**flip 단계:**
```json
{
  "question": "생성된 질문",
  "choice1": "첫 번째 선택지",
  "choice2": "두 번째 선택지"
}
```
- 다음 단계(roles)에 `question`, `choice1`, `choice2` 변수 전달
- LangChain 파싱 실패 시 `null` 반환 가능

**roles 단계:**
```json
{
  "structure": "역할 구조 정보"
}
```
- 다음 단계(ending)에 `structure` 변수 전달
- LangChain 파싱 실패 시 `null` 반환 가능

**ending 단계:**
```json
{
  "structure": "역할 구조 정보",
  "role": "할당된 역할"
}
```
- 마지막 단계 (다음 단계 없음)
- LangChain 파싱 실패 시 `null` 반환 가능

#### parsed_variables 동작 방식

1. **LangChain 파싱 성공 시**: 각 단계별로 위 예시와 같은 변수들이 포함된 객체 반환
2. **LangChain 파싱 실패 시**: `null` 반환 (이 경우 `response_text`만 사용)
3. **변수 저장**: `parsed_variables`의 값들은 자동으로 `context`에 저장되어 다음 단계에서 사용됨

---

## 3. 세션 정보 조회

### `GET /chat/session/{session_id}`

세션 정보를 조회합니다.

#### Response Schema

```json
{
  "session_id": "unique-session-id",
  "current_step": "opening",
  "context": {
    "opening_result": "...",
    "opening_user_input": "...",
    "dilemma_topic": "AI 윤리",
    "flip_question": "...",
    "flip_choice1": "...",
    "flip_choice2": "...",
    "roles_structure": "..."
  },
  "created_at": "2024-01-01T12:00:00",
  "updated_at": "2024-01-01T12:30:00"
}
```

---

## 4. 세션 삭제

### `DELETE /chat/session/{session_id}`

세션을 삭제합니다.

#### Response Schema

```json
{
  "message": "Session unique-session-id deleted successfully"
}
```

---

## 에러 응답

모든 API는 다음 형식의 에러 응답을 반환할 수 있습니다:

```json
{
  "detail": "에러 메시지"
}
```

### HTTP 상태 코드

- `400` - Bad Request (잘못된 요청)
- `500` - Internal Server Error (서버 오류)
- `502` - Bad Gateway (OpenAI API 오류)

---

## 주의사항

1. **LangChain 파싱 실패 시**: `parsed_variables` 또는 `parsed_result`가 `null`일 수 있습니다. 이 경우 원본 `response_text`를 사용하세요.

2. **변수 우선순위**: 
   - `prompt.variables` > `context` > `{}`
   - 이미지 생성 API에서 변수 처리 시 이 순서를 따릅니다.

3. **세션 관리**: 
   - 각 대화는 `session_id`로 관리됩니다.
   - 세션은 단계별 컨텍스트를 유지합니다.

4. **이미지 저장**: 
   - 생성된 이미지는 로컬에 저장되어 만료되지 않습니다.
   - 경로: `/static/generated_images/{filename}`

---

## FastAPI 자동 문서

서버 실행 후 다음 URL에서 자동 생성된 API 문서를 확인할 수 있습니다:

- Swagger UI: `https://dilemmai.org/docs`
- ReDoc: `https://dilemmai.org/redoc`

